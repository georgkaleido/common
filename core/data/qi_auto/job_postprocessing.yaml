apiVersion: batch/v1
kind: CronJob
metadata:
  name: qi-auto-postprocessing
spec:
  # Run twice a month (14th and 28th) at 3am
  schedule: "0 3 14,28 * *"
#  schedule: "56 17 30 * *" # TEST
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          # Necessary to have enough shared memory
          volumes:
            - name: dshm
              emptyDir:
                medium: Memory
          containers:
            - name: qi-auto-postprocessing
              image: eu.gcr.io/kaleido-train/trimap-qi-auto-postprocessing:v6
              imagePullPolicy: Always
              command: ["python", "-m", "qi_auto.postprocessing"]
              env:
                - name: GITHUB_AUTH_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: auth-secrets
                      key: github-token
              # Ensure that the node has a GPU
              resources:
                limits:
                  nvidia.com/gpu: 1
              # Necessary to have enough shared memory
              volumeMounts:
                - mountPath: /dev/shm
                  name: dshm
